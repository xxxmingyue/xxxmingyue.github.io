# 渗透测试之逻辑漏洞挖掘：支付系统

### 0x01. 特价商品数量突破 (限购绕过)

**漏洞原理：** 很多电商平台会推出“限时特价，每人限购一件”的活动。但由于前端与后端的校验不一致，导致限购逻辑被绕过。

**测试思路：**
在提交订单时，使用 Burp Suite 抓包，找到代表商品数量的参数（如 `qty=1`），尝试将其修改为 `5`、`10` 等大于限购数的值，观察是否能以特价购买超限的商品。

### 0x02. 普通商品数量篡改 (负数/溢出)

**漏洞原理：** 服务端未对商品数量参数进行严格的正整数校验（如过滤负数、小数、极大数）。

**测试思路：**

* **修改为 0 或负数：** 尝试将购买数量改为 `-1` 或 `0`，如果服务端逻辑是 `单价 * 数量 = 总价`，可能会导致总金额为负数（甚至反向退钱）或 0 元购。
* **极大值溢出：** 输入极大的数字，尝试造成数据库或系统整数溢出，导致最终支付金额变为极小值或负值。

### 0x03. 营销资产篡改 (金额/积分/优惠券)

营销资产的兑换和抵扣逻辑极其复杂，最容易出现逻辑校验遗漏。

**测试思路：**

1. **优惠券金额/折扣篡改：** 如果是满减券，尝试抓包修改优惠券的抵扣金额；如果是折扣券，尝试修改折扣力度（如将 0.8 改为 0.1）。
2. **优惠券并发使用/数量修改：** 尝试并发发包使用同一张优惠券，或修改使用数量。
3. **积分金额篡改：** 与优惠券类似，抓包查看积分抵扣请求，尝试修改消耗的积分数量或抵扣的金额参数。

### 0x04. 越权支付 (利用他人资产)

**漏洞原理：** 支付接口存在水平越权漏洞（IDOR/BOLA），服务端未校验当前支付者与订单所有者是否匹配。

**测试思路：**
在支付请求中，寻找是否有代表当前用户的身份标识，例如 `username=A`、`user_id=123` 或 `openid`。如果没有签名校验机制，可以尝试将该 ID 修改为其他用户的 ID（如管理员或其他受害者），从而实现**用他人的账户余额帮自己买单**。

### 0x05. 支付价格篡改 & 运费抵消

**漏洞原理：** 提交订单、确认支付、扣款三个步骤之间缺乏数据一致性校验。

**测试思路：**

* **直接改价：** 在任何有 `price`、`amount`、`total` 参数的请求包中，尝试将其修改为极小值（如 0.01）。
* **运费抵消术：** 如果商品价格无法篡改，尝试修改**运费 (shipping_fee)**。将运费修改为负数（例如商品 100 元，运费修改为 -99 元），系统自动相加后，最终支付金额可能变为 1 元。

### 0x06. 多重替换支付 (订单/商品置换)

**漏洞原理：** 网站未绑定“支付金额”与“商品/订单 ID”的一致性。

**测试思路：**

* **订单 ID 替换 (低价买高价)：** 正常创建两个订单（订单A：10元，订单B：1000元）。进入订单A的支付流程，抓包将其 `order_id` 替换为订单B的 ID。如果验证不严，即可用 10 元支付 1000 元的订单。
* **价格对冲：** 同时提交高价商品A（200元）和低价商品B（50元）。尝试抓包将商品B的价格改为 `-150`，打包提交，观察总金额是否变为 50 元。

### 0x07. 篡改支付状态 (虚假成功)

**漏洞原理：** 客户端过度信任前端返回的状态码，后端未进行异步的银行/第三方支付回调校验。

**测试思路：**
模拟点击支付，拦截服务器返回的响应包或者前端向后端的查询包。寻找类似 `pay_status=0` (未支付) 的字段，将其修改为 `pay_status=1` (已支付) 或 `success`，然后放包。观察系统是否直接发货。

### 0x08. 试用资格滥用 (无限并发/退还)

**漏洞原理：** 针对需要试用资格的商品，服务端的资格扣除与订单生成存在并发漏洞或逻辑死循环。

**测试思路：**

* **无限刷资格：** 利用 Burp Suite 的 Intruder 模块进行并发提交试用订单，看是否能用一个资格生成多个订单。
* **退货逻辑漏洞：** 申请试用后，再申请退回。观察是否存在退回次数大于申请次数的逻辑，导致试用资格反而增多。

### 0x09. 试用接口替换

**漏洞原理：** 开发者图省事，将“试用接口”与“正式支付接口”共用同一套底层逻辑，仅靠一个参数区分。

**测试思路：**
抓包分析，如果接口1是试用接口（0元），接口2是支付接口。尝试在支付时，将请求的 `API URL` 或业务标志位从“正式购买”替换为“试用”。如果系统按试用逻辑处理订单，就能实现 0 元购买正式商品。


